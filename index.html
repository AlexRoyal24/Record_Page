<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Club Coromac - Registro de Nataci√≥n</title>
<style>
:root{
  --azul-1:#0b78a6;
  --azul-2:#3db4d6;
  --blanco:#fff;
  --trans:0.18s;
  --card-radius:14px;
  --max-width:980px;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{
  font-family:Inter,sans-serif;
  min-height:100vh;
  background: radial-gradient(ellipse at 10% 10%, rgba(255,255,255,0.04), transparent 10%), linear-gradient(180deg,var(--azul-1),#022f3b);
  color:var(--blanco);
  display:flex;
  justify-content:center;
  align-items:flex-start;
  padding:20px;
}
.app{
  width:100%;
  max-width:var(--max-width);
  background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
  border-radius:18px;
  padding:18px;
  box-shadow:0 10px 30px rgba(0,0,0,0.4);
  -webkit-backdrop-filter: blur(6px);
  backdrop-filter: blur(6px);
}
header{
  display:flex;
  gap:12px;
  align-items:center;
  justify-content:space-between;
  margin-bottom:12px;
}
.logo{
  display:flex;
  gap:12px;
  align-items:center;
}
.logo .icon{
  width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--azul-2),var(--azul-1));
  display:flex;align-items:center;justify-content:center;font-weight:700;font-size:22px;color:rgba(255,255,255,0.95);
}
h1{font-size:20px;margin:0}
p.lead{font-size:13px;color:rgba(255,255,255,0.85)}
.card{
  background: rgba(255,255,255,0.04);
  padding:14px;
  border-radius:var(--card-radius);
  box-shadow:0 6px 18px rgba(2,18,24,0.25);
  margin-bottom:12px;
}
input, button, textarea{padding:10px 12px;border-radius:10px;border:0;outline:none;font-size:14px}
input::placeholder, textarea::placeholder{color:rgba(255,255,255,0.6)}
.btn{
  background:linear-gradient(90deg,var(--azul-2),var(--azul-1));
  color:var(--blanco);
  cursor:pointer;
  border:none;
  border-radius:10px;
  font-weight:600;
  transition:transform var(--trans), box-shadow var(--trans);
}
.btn:active{transform:translateY(1px)}
.small{font-size:13px;padding:8px 10px}
.muted{color:rgba(255,255,255,0.7);font-size:13px}
.card-content{display:none;margin-top:10px;}
.card-content.open{display:block;}
ul{padding-left:18px;}
textarea{width:100%;resize:none;margin-top:6px;}

/* Buscador estilo moderno */
#buscador {
  width: 100%;
  padding: 10px 40px 10px 12px;
  margin-bottom: 12px;
  border-radius: 12px;
  border: none;
  outline: none;
  font-size: 14px;
  background: rgba(255,255,255,0.08);
  color: var(--blanco);
  transition: background 0.2s;
}
#buscador::placeholder { color: rgba(255,255,255,0.6); }
#buscador:focus { background: rgba(255,255,255,0.15); }
#buscador-wrapper { position: relative; width: 100%; margin-bottom: 12px; }
#buscador-wrapper::before {
  content: "üîç";
  position: absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  pointer-events: none;
  font-size: 16px;
}
#buscador { padding-left: 36px; }
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="logo">
      <div class="icon">C</div>
      <div>
        <h1>Club Coromac ‚Äî Registro de Nataci√≥n</h1>
        <p class="lead">Responsive</p>
      </div>
    </div>
  </header>
  <main>
    <section id="left" class="card"></section>
  </main>
</div>

<script type="module">
// Importar Firebase y Chart.js
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.17.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/10.17.0/firebase-firestore.js";
import Chart from "https://cdn.jsdelivr.net/npm/chart.js";

// Configuraci√≥n Firebase
const firebaseConfig = {
  apiKey: "AIzaSyCMOjgT0Mb-bcA9fNlc23dc1DSKeyFPc1Y",
  authDomain: "recordpage-e86a1.firebaseapp.com",
  projectId: "recordpage-e86a1",
  storageBucket: "recordpage-e86a1.firebasestorage.app",
  messagingSenderId: "67394429287",
  appId: "1:67394429287:web:30ff1f8d82081feac2cfc2",
  measurementId: "G-W701BTFM3F"
};

// Inicializar Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const left = document.getElementById('left');

// Funci√≥n para renderizar todos los alumnos
function renderUsers(users){
  left.innerHTML = `
    <h3>Alumnos</h3>
    <div id="buscador-wrapper">
      <input type="text" id="buscador" placeholder="Buscar alumno...">
    </div>
    <div id='listaAlumnos'></div>
    <button class='btn small' id='btnNuevoAlumno'>+ Nuevo Alumno</button>
  `;

  const listaAlumnos = document.getElementById('listaAlumnos');
  listaAlumnos.innerHTML = "";

  users.forEach((u, idx) => {
    const card = document.createElement('div');
    card.className = 'card';
    card.setAttribute('data-nombre', u.nombre.toLowerCase());
    card.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center; cursor:pointer;">
        <strong>${u.nombre}</strong>
        <button class="btn small" id="btnAbrir_${idx}">Abrir</button>
      </div>
      <div id="contenido_${idx}" class="card-content"></div>
    `;
    listaAlumnos.appendChild(card);

    const btnAbrir = document.getElementById(`btnAbrir_${idx}`);
    const contenido = document.getElementById(`contenido_${idx}`);
    btnAbrir.onclick = () => {
      users.forEach((_, i) => {
        const c = document.getElementById(`contenido_${i}`);
        if(c && i!==idx) c.classList.remove('open');
      });
      contenido.classList.toggle('open');
      if(contenido.classList.contains('open')) renderAlumno(u, contenido, idx);
    };
  });

  // Buscador
  const buscador = document.getElementById('buscador');
  buscador.addEventListener('input', () => {
    const val = buscador.value.toLowerCase();
    document.querySelectorAll('#listaAlumnos .card').forEach(card => {
      if(card.dataset.nombre.includes(val)) card.style.display = '';
      else card.style.display = 'none';
    });
  });

  // Nuevo alumno
  document.getElementById('btnNuevoAlumno').onclick = async () => {
    const nombre = prompt("Nombre del nuevo alumno:");
    if(!nombre) return;
    if(users.find(x=>x.nombre===nombre)){alert("Ya existe"); return;}
    const newUser = {nombre, registros:[], notas:""};
    await addDoc(collection(db, "usuarios"), newUser);
  };
}

// Render alumno individual
function renderAlumno(u, container, idx){
  container.innerHTML = `
    <form id="form_${idx}">
      <label>Fecha</label>
      <input type="date" id="fecha_${idx}" required>
      <label>Metros nadados</label>
      <input type="number" id="metros_${idx}" placeholder="Ej: 1500" required>
      <div style="margin-top:6px; display:flex; gap:8px;">
        <button class="btn small" type="submit">Agregar registro</button>
        <button class="btn small" type="button" id="borrar_${idx}">Eliminar alumno</button>
      </div>
    </form>
    <div id="hist_${idx}" style="margin-top:8px;"></div>

    <h3>Instrucciones / Notas</h3>
    <textarea id="notas_${idx}" placeholder="Escribe aqu√≠ las instrucciones...">${u.notas||""}</textarea>

    <div id="chartContainer_${idx}" style="margin-top:10px;">
      <canvas id="chart_${idx}"></canvas>
    </div>
  `;

  document.getElementById(`form_${idx}`).onsubmit = async (e)=>{
    e.preventDefault();
    const fecha = document.getElementById(`fecha_${idx}`).value;
    const metros = parseInt(document.getElementById(`metros_${idx}`).value);
    if(!fecha || isNaN(metros)){ alert("Rellena fecha y metros"); return; }
    await addDoc(collection(doc(db, "usuarios", u.id), "registros"), {fecha, metros});
    document.getElementById(`fecha_${idx}`).value = "";
    document.getElementById(`metros_${idx}`).value = "";
  };

  document.getElementById(`borrar_${idx}`).onclick = async ()=>{
    if(confirm("¬øEliminar nadador?")) {
      await deleteDoc(doc(db, "usuarios", u.id));
    }
  };

  const notasTextarea = document.getElementById(`notas_${idx}`);
  notasTextarea.addEventListener('input', async ()=>{
    await updateDoc(doc(db,"usuarios",u.id), {notas: notasTextarea.value});
  });

  renderHistorial(u, idx);
  renderChartAlumno(u, idx);
}

function renderHistorial(u, idx){
  const hist = document.getElementById(`hist_${idx}`);
  let registros = u.registros || [];
  hist.innerHTML = "<ul>" + registros.map(r=>`<li>${r.fecha} ‚Äî ${r.metros} m</li>`).join('') + "</ul>";
}

function renderChartAlumno(u, idx){
  const canvas = document.getElementById(`chart_${idx}`);
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  let registros = u.registros || [];
  const labels = registros.map(r=>r.fecha.split('-').reverse().join('/'));
  const data = registros.map(r=>r.metros);
  if(window[`chartObj_${idx}`]) window[`chartObj_${idx}`].destroy();
  window[`chartObj_${idx}`] = new Chart(ctx,{
    type:'line',
    data:{labels,datasets:[{label:'Metros nadados',data,borderColor:'rgba(59,180,214,0.9)',backgroundColor:'rgba(59,180,214,0.3)',tension:0.3,fill:true}]},
    options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
  });
}

// Escuchar cambios en tiempo real
onSnapshot(collection(db,"usuarios"), async (snapshot)=>{
  const users = [];
  for(const docSnap of snapshot.docs){
    let data = docSnap.data();
    // Traer registros de subcolecci√≥n
    const registrosSnap = await getDocs(collection(db, "usuarios", docSnap.id, "registros"));
    data.registros = registrosSnap.docs.map(r=>r.data()).sort((a,b)=>a.fecha.localeCompare(b.fecha));
    users.push({id:docSnap.id, ...data});
  }
  renderUsers(users);
});
</script>
</body>
</html>
