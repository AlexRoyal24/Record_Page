<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Club Coromac - Registro de Nataci√≥n</title>
<style>
:root{
  --azul-1:#0b78a6;
  --azul-2:#3db4d6;
  --blanco:#fff;
  --trans:0.18s;
  --card-radius:14px;
  --max-width:980px;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{
  font-family:Inter,sans-serif;
  min-height:100vh;
  background: radial-gradient(ellipse at 10% 10%, rgba(255,255,255,0.04), transparent 10%), linear-gradient(180deg,var(--azul-1),#022f3b);
  color:var(--blanco);
  display:flex;
  justify-content:center;
  align-items:center;
  padding:20px;
}
.app{
  width:100%;
  max-width:var(--max-width);
  background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
  border-radius:18px;
  padding:18px;
  box-shadow:0 10px 30px rgba(0,0,0,0.4);
  -webkit-backdrop-filter: blur(6px);
  backdrop-filter: blur(6px);
}
header{
  display:flex;
  gap:12px;
  align-items:center;
  justify-content:space-between;
  margin-bottom:12px;
}
.logo{
  display:flex;
  gap:12px;
  align-items:center;
}
.logo .icon{
  width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--azul-2),var(--azul-1));
  display:flex;align-items:center;justify-content:center;font-weight:700;font-size:22px;color:rgba(255,255,255,0.95);
}
h1{font-size:20px;margin:0}
p.lead{font-size:13px;color:rgba(255,255,255,0.85)}
main{
  display:grid;
  grid-template-columns:340px 1fr;
  gap:16px;
}
.card{
  background: rgba(255,255,255,0.04);
  padding:14px;
  border-radius:var(--card-radius);
  box-shadow:0 6px 18px rgba(2,18,24,0.25);
}
form{display:flex;flex-direction:column;gap:8px}
input, button{padding:10px 12px;border-radius:10px;border:0;outline:none;font-size:14px}
input::placeholder{color:rgba(255,255,255,0.6)}
.btn{
  background:linear-gradient(90deg,var(--azul-2),var(--azul-1));
  color:var(--blanco);
  cursor:pointer;
  border:none;
  border-radius:10px;
  font-weight:600;
  transition:transform var(--trans), box-shadow var(--trans);
}
.btn:active{transform:translateY(1px)}
.small{font-size:13px;padding:8px 10px}
.muted{color:rgba(255,255,255,0.7);font-size:13px}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
.history{max-height:360px;overflow:auto;margin-top:8px}
table{width:100%;border-collapse:collapse;color:var(--blanco)}
th,td{padding:8px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.03);font-size:13px}
th{opacity:0.85;font-weight:600}
.message{margin-top:12px;padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));font-weight:600}

/* Panel de perfil */
#profileBtn{
  position:fixed;bottom:20px;right:20px;width:56px;height:56px;
  background:linear-gradient(135deg,var(--azul-2),var(--azul-1));
  border-radius:50%;
  display:flex;justify-content:center;align-items:center;
  font-weight:700;font-size:22px;color:white;
  cursor:pointer;z-index:1000;
}
#profilePanel{
  position:fixed;bottom:-100%;left:0;width:100%;max-width:480px;
  margin:0 auto;right:0;
  background: rgba(0,0,0,0.85);-webkit-backdrop-filter:blur(8px);backdrop-filter:blur(8px);
  border-top-left-radius:18px;border-top-right-radius:18px;
  padding:16px;
  transition:bottom 0.3s ease;
  color:white;z-index:999;
}
#profilePanel.open{bottom:0;}
#profilePanel img{width:80px;height:80px;border-radius:50%;object-fit:cover;margin-bottom:12px;}
#profilePanel input{margin-bottom:8px;}
#chartContainer{margin-top:16px;background:rgba(255,255,255,0.03);padding:12px;border-radius:10px;}

/* Modal agregar alumno */
#newStudentModal{
  position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
  background: rgba(0,0,0,0.9);
  padding:20px;
  border-radius:18px;
  display:none;
  z-index:2000;
  width:90%;
  max-width:400px;
}
#newStudentModal input{width:100%;margin-bottom:10px;}
#newStudentModal button{width:100%;}

/* Bot√≥n flotante nuevo alumno */
#newStudentBtn{
  position:fixed;bottom:90px;right:20px;width:56px;height:56px;
  background:linear-gradient(135deg,var(--azul-2),var(--azul-1));
  border-radius:50%;
  display:flex;justify-content:center;align-items:center;
  font-weight:700;font-size:14px;color:white;
  cursor:pointer;z-index:1000;
}

@media (max-width:900px){main{grid-template-columns:1fr};.grid{grid-template-columns:1fr}}
@media (max-width:450px){.logo .icon{width:44px;height:44px;font-size:18px};header{flex-direction:column;align-items:flex-start;gap:8px}}
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="logo">
      <div class="icon">C</div>
      <div>
        <h1>Club Coromac ‚Äî Registro de Nataci√≥n</h1>
        <p class="lead">Solo profesor ‚Ä¢ Responsive</p>
      </div>
    </div>
    <div id="topActions"></div>
  </header>
  <main>
    <section id="left" class="card"></section>
    <section id="right" class="card"></section>
  </main>
</div>

<!-- Botones flotantes -->
<div id="profileBtn">üë§</div>
<div id="newStudentBtn">+</div>

<!-- Panel de perfil -->
<div id="profilePanel">
  <div style="text-align:center;">
    <img id="profilePhoto" src="https://via.placeholder.com/80" alt="Foto de perfil">
    <input type="text" id="profileName" placeholder="Nombre">
    <input type="url" id="profileUrl" placeholder="URL de foto (opcional)">
    <div style="display:flex;gap:8px;justify-content:center;">
      <button class="btn small" id="saveProfile">Guardar</button>
      <button class="btn small" id="closeProfile">Cerrar</button>
    </div>
  </div>
</div>

<!-- Modal agregar alumno -->
<div id="newStudentModal">
  <h3>Agregar nuevo alumno</h3>
  <input type="text" id="newStudentName" placeholder="Nombre del alumno">
  <button class="btn" id="btnAddStudent">Agregar</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script>
const LS_USERS='natacion_users_v3';
const LS_CURRENT='natacion_current_v3';
const left=document.getElementById('left');
const right=document.getElementById('right');
const topActions=document.getElementById('topActions');
const profileBtn=document.getElementById('profileBtn');
const profilePanel=document.getElementById('profilePanel');
const profilePhoto=document.getElementById('profilePhoto');
const profileName=document.getElementById('profileName');
const profileUrl=document.getElementById('profileUrl');
const saveProfile=document.getElementById('saveProfile');
const closeProfile=document.getElementById('closeProfile');
const newStudentBtn=document.getElementById('newStudentBtn');
const newStudentModal=document.getElementById('newStudentModal');
const newStudentName=document.getElementById('newStudentName');
const btnAddStudent=document.getElementById('btnAddStudent');
const byId=id=>document.getElementById(id);

const PROFESOR_KEY="Club_Coromac_2025"; // Cambiar clave real

function requireProfessorAccess(){
  const key=sessionStorage.getItem('profesor_access');
  if(key===PROFESOR_KEY) return true;
  let attempt=prompt("Acceso solo para profesor. Ingresa clave:");
  if(attempt===PROFESOR_KEY){sessionStorage.setItem('profesor_access',attempt); return true;}
  alert("Clave incorrecta. No puedes entrar."); return false;
}

function loadUsers(){return JSON.parse(localStorage.getItem(LS_USERS)||'[]');}
function saveUsers(u){localStorage.setItem(LS_USERS,JSON.stringify(u));}
function setCurrent(name){localStorage.setItem(LS_CURRENT,name);}
function getCurrent(){return localStorage.getItem(LS_CURRENT);}
function logout(){localStorage.removeItem(LS_CURRENT); render();}

// --------- RENDER PRINCIPAL ---------
function render(){
  if(!requireProfessorAccess()){left.innerHTML="Acceso denegado"; right.innerHTML=""; return;}
  const current=getCurrent();
  const users=loadUsers();

  // Si no hay alumno seleccionado, mostrar modal para agregar
  if(!current){
    showNewStudentModal();
    left.innerHTML=''; right.innerHTML='';
  } else {
    const me=users.find(u=>u.nombre===current);
    if(!me){logout(); return;}
    topActions.innerHTML=`<div class="muted">Nadador: <strong>${me.nombre}</strong></div> <div style="display:flex;gap:8px"><button class="link" id="btnExport">Exportar PDF</button><button class="link" id="btnLogout">Cerrar sesi√≥n</button></div>`;
    
    left.innerHTML=`<form id="registroForm">
      <label class="muted">Fecha</label><input id="inpFecha" type="date" required/>
      <label class="muted">Metros nadados</label><input id="inpMetros" type="number" min="0" placeholder="Ej: 1500" required/>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn" type="submit">Agregar</button>
        <button class="btn small" id="btnBorrarCuenta" type="button">Eliminar nadador</button>
      </div>
    </form>
    <div class="message" id="msgSmall">Tus mensajes aparecer√°n aqu√≠.</div>`;
    
    right.innerHTML=`<h3>Historial & Progreso</h3>
      <div class="grid">
        <div class="card" style="padding:10px"><div class="muted">Total sesiones</div><div style="font-weight:700;font-size:20px;margin-top:6px">${me.registros.length}</div></div>
        <div class="card" style="padding:10px"><div class="muted">Metros acumulados</div><div style="font-weight:700;font-size:20px;margin-top:6px">${me.registros.reduce((s,a)=>s+parseInt(a.metros||0),0)} m</div></div>
      </div>
      <div class="history"><table><thead><tr><th>Fecha</th><th>Metros</th><th>Cambio</th><th>Eliminar</th></tr></thead><tbody id="tblBody"></tbody></table></div>
      <div id="chartContainer"><canvas id="chartProgress"></canvas></div>`;
    
    document.getElementById('registroForm').addEventListener('submit',e=>{e.preventDefault(); addRegistro(me.nombre);});
    document.getElementById('btnLogout').onclick=()=>{logout();};
    document.getElementById('btnExport').onclick=()=>exportPDF(me);
    document.getElementById('btnBorrarCuenta').onclick=()=>deleteAccount(me.nombre);
    renderHistory(me); renderSmallMsg(me); renderChart(me);

    profileName.value=me.nombre;
    profilePhoto.src=me.foto||'https://via.placeholder.com/80';
    profileUrl.value=me.foto||'';
  }
}

// --------- FUNCIONES MODAL NUEVO ALUMNO ---------
function showNewStudentModal(){
  newStudentModal.style.display='block';
  newStudentName.value='';
}
function hideNewStudentModal(){
  newStudentModal.style.display='none';
}
newStudentBtn.onclick=()=>showNewStudentModal();
btnAddStudent.onclick=()=>{
  const nombre=newStudentName.value.trim();
  if(!nombre){alert('Ingresa nombre'); return;}
  const users=loadUsers();
  if(users.find(u=>u.nombre===nombre)){alert('Ya existe'); return;}
  users.push({nombre,registros:[]});
  saveUsers(users);
  setCurrent(nombre);
  hideNewStudentModal();
  render();
}

// --------- FUNCIONES DE REGISTRO ---------
function addRegistro(nombre){
  const fecha=byId('inpFecha').value;
  const metros=parseInt(byId('inpMetros').value);
  if(!fecha||isNaN(metros)){alert('Rellena fecha y metros'); return;}
  const users=loadUsers();
  const user=users.find(u=>u.nombre===nombre);
  user.registros.push({fecha,metros});
  saveUsers(users);
  render();
  const prev=user.registros.length>1?user.registros[user.registros.length-2]:null;
  showMotivationMessage(user,metros,prev);
}

function renderHistory(user){
  const tbody=byId('tblBody'); tbody.innerHTML='';
  user.registros.slice().reverse().forEach((r,idx)=>{
    const i=user.registros.length-1-idx;
    const prev=i>0?user.registros[i-1]:null;
    const change=prev?((r.metros-prev.metros)>=0?'+'+(r.metros-prev.metros)+' m':(r.metros-prev.metros)+' m'):'‚Äî';
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.fecha.split('-').reverse().join('/')}</td><td>${r.metros} m</td><td>${change}</td><td><button class="btn small" onclick="deleteRegistro('${user.nombre}',${i})">üóëÔ∏è</button></td>`;
    tbody.appendChild(tr);
  });
}

function deleteRegistro(nombre,index){
  if(!confirm("Eliminar registro?")) return;
  const users=loadUsers();
  const user=users.find(u=>u.nombre===nombre);
  user.registros.splice(index,1);
  saveUsers(users);
  render();
}

function renderSmallMsg(user){
  const msg=byId('msgSmall');
  if(user.registros.length===0){msg.textContent='A√∫n no tienes registros. ¬°Agrega tu primer entrenamiento!';return;}
  const last=user.registros[user.registros.length-1];
  msg.textContent=`√öltima sesi√≥n: ${last.fecha.split('-').reverse().join('/')} ‚Äî ${last.metros} m`;
}

function showMotivationMessage(user,metros,prev){
  let text='';
  if(!prev){text=`¬°Buen inicio, ${user.nombre}! Has registrado ${metros} m. Sigue as√≠.`;}
  else{
    const diff=metros-prev.metros;
    if(diff>0)text=`üèÖ ¬°Excelente, ${user.nombre}! Superaste tu marca anterior en ${diff} m (antes ${prev.metros} m).`;
    else if(diff<0)text=`üåä Vamos ${user.nombre}, esta vez ${metros} m (falta ${prev.metros-metros} m para tu marca de ${prev.metros} m). ¬°T√∫ puedes volver a tus ${prev.metros} m o superarlos!`;
    else text=`üîÅ Gran constancia, ${user.nombre}! Repetiste ${metros} m ‚Äî mantener el ritmo tambi√©n cuenta.`;
  }
  const banner=document.querySelector('.message'); if(banner){banner.textContent=text;banner.style.opacity='1';}
  showToast(text);
}

function showToast(text){
  const t=document.createElement('div');
  t.style.position='fixed';
  t.style.left='50%';
  t.style.transform='translateX(-50%)';
  t.style.bottom='22px';
  t.style.padding='12px 16px';
  t.style.background='linear-gradient(90deg,var(--azul-2),var(--azul-1))';
  t.style.color='white';
  t.style.borderRadius='10px';
  t.style.boxShadow='0 6px 18px rgba(0,0,0,0.25)';
  t.style.fontWeight='700';
  t.style.zIndex='5000';
  t.style.opacity='0';
  t.style.transition='opacity 0.3s';
  t.textContent=text;
  document.body.appendChild(t);
  setTimeout(()=>t.style.opacity='1',10);
  setTimeout(()=>{t.style.opacity='0';setTimeout(()=>t.remove(),300)},4000);
}

// --------- PANEL PERFIL ---------
profileBtn.onclick=()=>profilePanel.classList.toggle('open');
closeProfile.onclick=()=>profilePanel.classList.remove('open');
saveProfile.onclick=()=>{
  const users=loadUsers();
  const current=getCurrent();
  const user=users.find(u=>u.nombre===current);
  user.nombre=profileName.value.trim()||user.nombre;
  user.foto=profileUrl.value.trim()||user.foto;
  saveUsers(users);
  render();
};

// --------- EXPORT PDF ---------
function exportPDF(user){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const title="Club Coromac - Registro de Nataci√≥n";
  doc.setFontSize(18); doc.text(title,14,22);
  const data=user.registros.map(r=>[r.fecha.split('-').reverse().join('/'),r.metros]);
  doc.autoTable({head:[['Fecha','Metros']],body:data,startY:30});
  doc.save(`${user.nombre}-registro.pdf`);
}

// --------- ELIMINAR CUENTA ---------
function deleteAccount(nombre){
  if(!confirm("Eliminar alumno y todos los registros?")) return;
  let users=loadUsers();
  users=users.filter(u=>u.nombre!==nombre);
  saveUsers(users);
  logout();
}

// --------- CHART JS ---------
function renderChart(user){
  const ctx=document.getElementById('chartProgress').getContext('2d');
  const labels=user.registros.map(r=>r.fecha.split('-').reverse().join('/'));
  const data=user.registros.map(r=>r.metros);
  new Chart(ctx,{type:'line',data:{labels, datasets:[{label:'Metros nadados', data, backgroundColor:'rgba(59,180,214,0.3)', borderColor:'#3db4d6', borderWidth:2, tension:0.3}]}, options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});
}

// --------- INICIALIZACI√ìN ---------
render();
</script>
</body>
</html>
