<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Record_Pages</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{
    font-family: Arial, sans-serif;
    background:#f2f4f7;
    padding:20px;
    margin:0;
}
.card{
    background:#fff;
    padding:15px;
    margin-bottom:15px;
    border-radius:8px;
    box-shadow:0 2px 6px rgba(0,0,0,.1);
}
.hidden{ display:none; }

button,input,textarea{
    padding:10px;
    margin:6px 0;
    box-sizing:border-box;
    font-size:15px;
}

button{
    cursor:pointer;
}

.alumno{
    border-left:6px solid #2196f3;
}

canvas{ margin-top:10px; }

/* BUSCADOR */
.search-box{
    display:flex;
    justify-content:center;
    margin-bottom:20px;
}
.search-box input{
    width:60%;
    max-width:600px;
    font-size:18px;
    padding:12px;
}

/* BOTÃ“N CREAR */
.create-box{
    display:flex;
    justify-content:center;
    margin-bottom:30px;
}
.create-box button{
    width:250px;
    font-size:16px;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginBox" class="card">
    <h2>Ingreso Profesor</h2>
    <input type="password" id="password" placeholder="ContraseÃ±a">
    <button type="button" onclick="doLogin()">Ingresar</button>
</div>

<!-- PANEL -->
<div id="panel" class="hidden">
    <h2 id="profName" style="text-align:center"></h2>

    <!-- BUSCADOR -->
    <div class="search-box">
        <input type="text" id="search" placeholder="Buscar alumno..." oninput="renderAlumnos()">
    </div>

    <!-- CREAR -->
    <div class="create-box">
        <button type="button" onclick="crearAlumno()">âž• Crear carpeta de alumno</button>
    </div>

    <div id="alumnos"></div>
</div>

<script>
/* ===== CONFIG ===== */
const profesores = {
    prof1:"Profesor 1",
    prof2:"Profesor 2",
    prof3:"Profesor 3"
};

let profesorActual = null;

/* ===== DATA ===== */
let data = JSON.parse(localStorage.getItem("natacionData")) || {
    profesores:{ prof1:[], prof2:[], prof3:[] }
};

function save(){
    localStorage.setItem("natacionData", JSON.stringify(data));
}

/* ===== LOGIN ===== */
function doLogin(){
    const pass = document.getElementById("password").value.trim();

    if(profesores[pass]){
        profesorActual = pass;
        document.getElementById("loginBox").classList.add("hidden");
        document.getElementById("panel").classList.remove("hidden");
        document.getElementById("profName").innerText = profesores[pass];
        renderAlumnos();
    }else{
        alert("ContraseÃ±a incorrecta");
    }
}

/* ===== CREAR ALUMNO (ARREGLADO) ===== */
function crearAlumno(){
    if(!profesorActual) return;

    data.profesores[profesorActual].push({
        nombre:"Alumno sin nombre",
        registros:[],
        comentario:""
    });

    save();
    renderAlumnos();
}

/* ===== RENDER ===== */
function renderAlumnos(){
    const cont = document.getElementById("alumnos");
    const filtro = document.getElementById("search").value.toLowerCase();
    cont.innerHTML = "";

    data.profesores[profesorActual]
    .filter(a => a.nombre.toLowerCase().includes(filtro))
    .forEach((a,i)=>{
        const div = document.createElement("div");
        div.className = "card alumno";

        div.innerHTML = `
            <input value="${a.nombre}">
            <input type="number" placeholder="Metros nadados">
            <button type="button">Agregar metros</button>

            <canvas id="chart${i}"></canvas>

            <textarea placeholder="Comentario">${a.comentario}</textarea>
            <button type="button">ðŸ“¥ Descargar PDF</button>
        `;

        cont.appendChild(div);

        const nameInput = div.querySelectorAll("input")[0];
        const metrosInput = div.querySelectorAll("input")[1];
        const addBtn = div.querySelectorAll("button")[0];
        const comment = div.querySelector("textarea");
        const pdfBtn = div.querySelectorAll("button")[1];

        nameInput.onchange = ()=>{
            a.nombre = nameInput.value || "Alumno sin nombre";
            save();
            renderAlumnos();
        };

        comment.onchange = ()=>{
            a.comentario = comment.value;
            save();
        };

        addBtn.onclick = ()=>{
            if(!metrosInput.value) return;
            a.registros.push({
                fecha:new Date().toLocaleDateString(),
                metros:Number(metrosInput.value)
            });
            metrosInput.value="";
            save();
            renderAlumnos();
        };

        setTimeout(()=>drawChart(`chart${i}`, a.registros),0);

        pdfBtn.onclick = ()=>{
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();
            pdf.text(`Alumno: ${a.nombre}`,10,10);
            let y=20;
            a.registros.forEach(r=>{
                pdf.text(`${r.fecha}: ${r.metros} m`,10,y);
                y+=8;
            });
            pdf.text("Comentario:",10,y+5);
            pdf.text(a.comentario || "-",10,y+13);
            pdf.save(`${a.nombre}.pdf`);
        };
    });
}

/* ===== GRAFICA ===== */
function drawChart(id, registros){
    const canvas = document.getElementById(id);
    if(!canvas) return;

    new Chart(canvas,{
        type:"line",
        data:{
            labels: registros.map(r=>r.fecha),
            datasets:[{
                label:"Metros nadados",
                data: registros.map(r=>r.metros),
                borderWidth:2,
                tension:0.3
            }]
        },
        options:{
            scales:{
                x:{ title:{display:true,text:"Fecha"} },
                y:{ title:{display:true,text:"Metros"}, beginAtZero:true }
            }
        }
    });
}
</script>

</body>
</html>
